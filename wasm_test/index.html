<html>
    <head>
        <meta charset="utf-8"/>
        <script src="wasm_exec.js"></script>
        <script>
            let go = new Go();

            async function runWasmWithInput(inputText) {
                // Set up args: first is program name, then your args
                go.argv = ["main.wasm", "execute", inputText];

                // Capture output
                const outputElem = document.getElementById("output");
                let output = "";
                const origLog = console.log;
                const origErr = console.error;
                console.log = function(...args) {
                    output += args.join(" ") + "\n";
                    origLog.apply(console, args);
                };
                console.error = function(...args) {
                    output += args.join(" ") + "\n";
                    origErr.apply(console, args);
                };

                outputElem.textContent = ""; // Clear previous output

                try {
                    const result = await WebAssembly.instantiateStreaming(fetch("main.wasm"), go.importObject);
                    await go.run(result.instance);
                } finally {
                    console.log = origLog;
                    console.error = origErr;
                    outputElem.textContent = output;
                }
            }

            async function runInPlayground() {
                const code = document.getElementById("code").value;
                const outputElem = document.getElementById("output");
                
                // First, get the generated Go code
                go.argv = ["main.wasm", "execute", code];
                
                let generatedCode = "";
                const origLog = console.log;
                const origErr = console.error;
                console.log = function(...args) {
                    generatedCode += args.join(" ") + "\n";
                    origLog.apply(console, args);
                };
                console.error = function(...args) {
                    generatedCode += args.join(" ") + "\n";
                    origErr.apply(console, args);
                };

                try {
                    const result = await WebAssembly.instantiateStreaming(fetch("main.wasm"), go.importObject);
                    await go.run(result.instance);
                } finally {
                    console.log = origLog;
                    console.error = origErr;
                }

                // Now send to Go Playground
                outputElem.textContent = "Sending to Go Playground...";
                
                try {
                    const response = await fetch("https://play.golang.org/compile", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/x-www-form-urlencoded",
                        },
                        body: `body=${encodeURIComponent(generatedCode)}`
                    });
                    
                    const data = await response.json();
                    
                    if (data.Errors) {
                        outputElem.textContent = `Compilation Error:\n${data.Errors}`;
                    } else {
                        outputElem.textContent = `Generated Code:\n${generatedCode}\n\nExecution Output:\n${data.Events[0].Message}`;
                    }
                } catch (error) {
                    outputElem.textContent = `Error sending to Go Playground: ${error.message}`;
                }
            }

            window.onload = function() {
                document.getElementById("runBtn").onclick = function() {
                    const code = document.getElementById("code").value;
                    runWasmWithInput(code);
                };
                document.getElementById("playgroundBtn").onclick = function() {
                    runInPlayground();
                };
            };
        </script>
    </head>
    <body>
        <textarea name="code" id="code" rows="10" cols="50">package main
func test() int? { 42 }</textarea>
        <button id="runBtn">Run</button>
        <button id="playgroundBtn">Run in Go Playground</button>
        <pre id="output"></pre>
    </body>
</html>
